# AWS Lambda Integration for Axway API Gateway

Este projeto oferece integra√ß√£o com AWS Lambda atrav√©s de filtros customizados para o Axway API Gateway, suportando tanto filtros Java quanto scripts Groovy.

## API Management Version Compatibility

Este artefato foi testado com sucesso nas seguintes vers√µes:
- **Axway API Gateway 7.7.0.20240830** ‚úÖ

## Vis√£o Geral

O projeto oferece duas abordagens para integra√ß√£o com AWS Lambda:

### 1. Filtro Java (Recomendado)
- Interface gr√°fica no Policy Studio
- Configura√ß√£o via par√¢metros visuais
- Performance nativa do gateway
- Build automatizado

### 2. Script Groovy (Alternativa)
- Flexibilidade total
- Edi√ß√£o direta do script
- Configura√ß√£o din√¢mica
- Debugging detalhado

## üì¶ Releases do GitHub

### **Downloads Autom√°ticos**

Os releases s√£o criados automaticamente no GitHub e incluem:

#### **Arquivos Dispon√≠veis em Cada Release:**
- **JAR Principal** - `aws-lambda-apim-sdk-*.jar` (compilado para m√∫ltiplas vers√µes do Axway)
- **Depend√™ncias Externas** - pasta `dependencies/` com JARs AWS SDK
- **Recursos Policy Studio** - `src/main/resources/fed/` e `src/main/resources/yaml/`
- **Gradle Wrapper** - `gradlew`, `gradlew.bat` e pasta `gradle/`
- **Configura√ß√£o Gradle** - `build.gradle` com tarefas de instala√ß√£o
- **Script Linux** - `install-linux.sh` para instala√ß√£o autom√°tica

#### **Instala√ß√£o a partir do Release:**

**Windows (Recomendado):**
```bash
# Extraia o ZIP do release
# Navegue at√© a pasta extra√≠da
# Execute a tarefa Gradle:
.\gradlew "-Dproject.path=C:\Users\jbarros\apiprojects\DIGIO-POC-AKS-NEW" installWindowsToProject
```

**Linux:**
```bash
# Extraia o ZIP do release
# Execute o script de instala√ß√£o:
./install-linux.sh
```

### **Vers√µes Suportadas:**
- **Axway API Gateway 7.7.0.20240830** ‚úÖ
- **Axway API Gateway 7.7.0.20250230** ‚úÖ

---

## Build e Instala√ß√£o

### üîß Configura√ß√£o Din√¢mica

O projeto suporta **configura√ß√£o din√¢mica** do caminho do Axway API Gateway:

```bash
# Configura√ß√£o padr√£o
./gradlew clean build installLinux

# Configura√ß√£o customizada
./gradlew -Daxway.base=/opt/axway/Axway-7.7.0.20210830 clean build installLinux

# Verificar configura√ß√£o atual
./gradlew setAxwayPath
```

### Linux
```bash
# Build do JAR (apenas Linux)
./gradlew buildJarLinux

# Build e instala√ß√£o autom√°tica
./gradlew clean build installLinux

# Com caminho customizado
./gradlew -Daxway.base=/caminho/para/axway clean build installLinux
```

### Windows
```bash
# Instala√ß√£o apenas dos arquivos YAML em projeto Policy Studio
./gradlew installWindows

# Instala√ß√£o em projeto espec√≠fico (com caminho)
./gradlew "-Dproject.path=C:\Users\jbarros\apiprojects\DIGIO-POC-AKS" installWindowsToProject

# Instala√ß√£o interativa (se n√£o especificar caminho)
./gradlew installWindowsToProject
```

> üìñ **Guia Completo Windows**: Veja **[üìã Guia de Instala√ß√£o Windows](docs/INSTALACAO_WINDOWS.md)** para instru√ß√µes detalhadas.

### üê≥ **Docker**

#### **Imagem Docker Publicada**

Este projeto usa a imagem Docker publicada `axwayjbarros/aws-lambda-apim-sdk:1.0.0` que cont√©m:
- Axway API Gateway 7.7.0.20240830
- Java 11 OpenJDK
- AWS SDK for Java 1.12.314
- Gradle para build
- Todas as depend√™ncias necess√°rias

#### **Build usando Docker**

```bash
# Build do JAR usando a imagem publicada
./scripts/build-with-docker-image.sh

# Ou manualmente:
docker pull axwayjbarros/aws-lambda-apim-sdk:1.0.0
docker run --rm \
  -v "$(pwd):/workspace" \
  -v "$(pwd)/build:/workspace/build" \
  -w /workspace \
  axwayjbarros/aws-lambda-apim-sdk:1.0.0 \
  bash -c "
    export JAVA_HOME=/opt/java/openjdk-11
    export PATH=\$JAVA_HOME/bin:\$PATH
    gradle clean build
  "
```
```

> üí° **Dica**: O GitHub Actions usa a imagem publicada `axwayjbarros/aws-lambda-apim-sdk:1.0.0`.

#### **Testar Imagem Publicada**

```bash
# Testar a imagem publicada


# Ou manualmente:
docker pull axwayjbarros/aws-lambda-apim-sdk:1.0.0
docker run --rm axwayjbarros/aws-lambda-apim-sdk:1.0.0 java -version
docker run --rm axwayjbarros/aws-lambda-apim-sdk:1.0.0 ls -la /opt/Axway/
```

> ‚ö†Ô∏è **Nota**: Esta imagem √© **apenas para build**, n√£o para execu√ß√£o de aplica√ß√£o.

#### **Estrutura de JARs na Imagem**

A imagem inclui os seguintes JARs organizados:

```
/opt/Axway/apigateway/lib/
‚îú‚îÄ‚îÄ aws-java-sdk-lambda-*.jar          # AWS Lambda SDK
‚îú‚îÄ‚îÄ aws-java-sdk-core-*.jar            # AWS Core SDK
‚îî‚îÄ‚îÄ jackson-*.jar                      # Jackson JSON library
```

#### **Uso da Imagem para Build**

A imagem `axwayjbarros/aws-lambda-apim-sdk:1.0.0` √© usada **apenas para build**, n√£o para execu√ß√£o. Ela cont√©m todas as bibliotecas do Axway API Gateway necess√°rias para compilar o projeto:

```bash
# Build usando a imagem (apenas bibliotecas)
docker run --rm \
  -v "$(pwd):/workspace" \
  -v "$(pwd)/build:/workspace/build" \
  -w /workspace \
  axwayjbarros/aws-lambda-apim-sdk:1.0.0 \
  bash -c "
    export JAVA_HOME=/opt/java/openjdk-11
    export PATH=\$JAVA_HOME/bin:\$PATH
    gradle clean build
  "
```

#### **Especifica√ß√µes da Imagem:**
- **Base**: Axway API Gateway 7.7.0.20240830-4-BN0145-ubi9
- **Java**: OpenJDK 11.0.27
- **Bibliotecas**: Todas as libs do Axway API Gateway dispon√≠veis
- **Uso**: Apenas para build do projeto, n√£o para execu√ß√£o

#### **GitHub Actions**

O projeto usa a imagem para build automatizado:

- **Build Cont√≠nuo**: `.github/workflows/build-jar.yml`
- **Release**: `.github/workflows/release.yml`
- **Imagem**: `axwayjbarros/aws-lambda-apim-sdk:1.0.0`

> üìñ **Docker**: A documenta√ß√£o Docker est√° integrada nesta se√ß√£o do README.

### ‚ö†Ô∏è **Importante: Build do JAR**

O **build do JAR deve ser feito no Linux** devido √†s depend√™ncias do Axway API Gateway. Para Windows:

1. **Build no Linux:**
   ```bash
   ./gradlew buildJarLinux
   ```

2. **Copiar JAR para Windows:**
   ```bash
   # Copie o arquivo: build/libs/aws-lambda-apim-sdk-1.0.1.jar
   # Para o ambiente Windows
   ```

3. **Instalar YAML no Windows:**
   ```bash
   ./gradlew installWindows
   ```

### üîÑ **Processo Linux vs Windows**

| Linux | Windows |
|-------|---------|
| ‚úÖ Build do JAR | ‚ùå Build do JAR |
| ‚úÖ Instala√ß√£o completa | ‚úÖ Instala√ß√£o YAML |
| ‚úÖ Depend√™ncias nativas | ‚ö†Ô∏è JARs externos |
| ‚úÖ Configura√ß√£o autom√°tica | ‚ö†Ô∏è Configura√ß√£o manual |

**Linux**: Processo completo (JAR + YAML + instala√ß√£o)  
**Windows**: Apenas YAML (JAR deve ser buildado no Linux)

### Comandos √öteis
```bash
# Ver todas as tasks dispon√≠veis
./gradlew showTasks

# Mostrar links dos JARs AWS SDK
./gradlew showAwsJars

# Verificar configura√ß√£o do Axway
./gradlew setAxwayPath

# Apenas build
./gradlew clean build
```

## üìö Documenta√ß√£o

Este projeto possui documenta√ß√£o completa organizada por t√≥picos:

### üöÄ **Guias de Instala√ß√£o**
- **[üìã Guia de Instala√ß√£o Windows](docs/INSTALACAO_WINDOWS.md)** - Instru√ß√µes detalhadas para Windows
- **[üîß Configura√ß√£o Din√¢mica](docs/CONFIGURACAO_DINAMICA.md)** - Como configurar caminhos do Axway dinamicamente

### üîß **Desenvolvimento e Build**
- **[üè∑Ô∏è Guia de Releases](docs/RELEASE_GUIDE.md)** - Como criar releases e versionamento
- **[üìä Versionamento Sem√¢ntico](docs/SEMANTIC_VERSIONING.md)** - Sistema autom√°tico de versionamento
- **[ü§ñ Sistema de Release Autom√°tico](docs/AUTOMATIC_RELEASE_SYSTEM.md)** - An√°lise inteligente e cria√ß√£o autom√°tica de releases
- **[üîß Refer√™ncia dos Scripts](docs/SCRIPTS_REFERENCE.md)** - Documenta√ß√£o dos scripts essenciais

### üìù **Documenta√ß√£o T√©cnica**
- **[üîç Atualiza√ß√µes de Campos](docs/ATUALIZACOES_CAMPOS_FILTRO.md)** - Hist√≥rico de mudan√ßas nos campos do filtro
- **[üîê Melhorias de Autentica√ß√£o AWS](docs/MELHORIAS_AUTENTICACAO_AWS.md)** - Configura√ß√µes avan√ßadas de autentica√ß√£o
- **[üìñ Documenta√ß√£o Groovy](docs/AWS_LAMBDA_GROOVY_DOCUMENTATION.md)** - Guia completo para scripts Groovy

### üìã **Estrutura da Documenta√ß√£o**
```
docs/
‚îú‚îÄ‚îÄ üìã INSTALACAO_WINDOWS.md              # Instala√ß√£o no Windows
‚îú‚îÄ‚îÄ üîß CONFIGURACAO_DINAMICA.md           # Configura√ß√£o din√¢mica
‚îú‚îÄ‚îÄ üè∑Ô∏è RELEASE_GUIDE.md                   # Guia de releases
‚îú‚îÄ‚îÄ üìä SEMANTIC_VERSIONING.md             # Versionamento sem√¢ntico
‚îú‚îÄ‚îÄ üîç ATUALIZACOES_CAMPOS_FILTRO.md     # Hist√≥rico de campos
‚îú‚îÄ‚îÄ üîê MELHORIAS_AUTENTICACAO_AWS.md     # Autentica√ß√£o AWS
‚îî‚îÄ‚îÄ üìñ AWS_LAMBDA_GROOVY_DOCUMENTATION.md # Documenta√ß√£o Groovy
```

---

## Instala√ß√£o Manual (Alternativa)

### Linux

1. **Build e instala√ß√£o autom√°tica:**
   ```bash
   ./gradlew clean build
   ./scripts/linux/install-filter.sh
   ```

2. **Configurar Policy Studio:**
   - Abra o Policy Studio
   - V√° em **Window > Preferences > Runtime Dependencies**
   - Adicione o JAR: `/opt/axway/Axway-7.7.0.20240830/apigateway/groups/group-2/instance-1/ext/lib/aws-lambda-apim-sdk-1.0.1.jar`
   - Reinicie o Policy Studio com `-clean`

### Windows

1. **Instalar arquivos YAML (interativo):**
   ```bash
   ./gradlew installWindows
   ```
   O Gradle solicitar√° o caminho do projeto Policy Studio.

2. **Instalar arquivos YAML em projeto espec√≠fico:**
   ```bash
   ./gradlew -Dproject.path=C:\caminho\do\projeto installWindowsToProject
   ```

3. **Ver links dos JARs AWS SDK:**
   ```bash
   ./gradlew showAwsJars
   ```

4. **Configurar Policy Studio:**
   - Abra o Policy Studio
   - V√° em **Window > Preferences > Runtime Dependencies**
   - Adicione o JAR: `aws-lambda-apim-sdk-1.0.1.jar`
   - Reinicie o Policy Studio com `-clean`

## Configura√ß√£o AWS

### Credenciais

#### 1. Arquivo de Credenciais (Recomendado)
```ini
# ~/.aws/credentials
[default]
aws_access_key_id = sua_access_key
aws_secret_access_key = sua_secret_key
aws_session_token = seu_session_token  # opcional
```

#### 2. Vari√°veis de Ambiente
```bash
export AWS_ACCESS_KEY_ID="sua_access_key"
export AWS_SECRET_ACCESS_KEY="sua_secret_key"
export AWS_SESSION_TOKEN="seu_session_token"  # opcional
export AWS_DEFAULT_REGION="us-east-1"
```

#### 3. IAM Roles (Recomendado para Produ√ß√£o)

**Para EKS (Kubernetes):**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: axway-api-gateway
spec:
  template:
    spec:
      serviceAccountName: axway-gateway-sa
      containers:
      - name: axway-gateway
        image: axway/api-gateway:latest
        # Sem vari√°veis de ambiente - usa IAM Role automaticamente
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: axway-gateway-sa
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT:role/axway-lambda-role
```

**Para EC2:**
- Anexe um IAM Role √† inst√¢ncia EC2
- O filtro Java detectar√° automaticamente as credenciais

**Vantagens:**
- ‚úÖ Seguran√ßa m√°xima (sem credenciais est√°ticas)
- ‚úÖ Rota√ß√£o autom√°tica de credenciais
- ‚úÖ Auditoria via CloudTrail
- ‚úÖ Funciona com filtro Java e script Groovy

## Uso

### Filtro Java

1. **Adicionar filtro √† pol√≠tica:**
   - Abra o Policy Studio
   - Procure por **"AWS Lambda Filter"** na paleta
   - Arraste o filtro para a pol√≠tica

2. **Configurar par√¢metros:**
   - `functionName` (obrigat√≥rio): Nome da fun√ß√£o Lambda
   - `awsRegion` (opcional): Regi√£o AWS (padr√£o: `us-east-1`)
   - `invocationType` (opcional): Tipo de invoca√ß√£o (padr√£o: `RequestResponse`)
   - `logType` (opcional): Tipo de log (padr√£o: `None`)
   - `qualifier` (opcional): Vers√£o ou alias da fun√ß√£o
   - `maxRetries` (opcional): N√∫mero m√°ximo de tentativas (padr√£o: `3`)
   - `retryDelay` (opcional): Delay entre tentativas em ms (padr√£o: `1000`)

3. **Atributos de sa√≠da:**
   - `aws.lambda.response`: Resposta da fun√ß√£o Lambda
   - `aws.lambda.http.status.code`: C√≥digo de status HTTP

4. **Autentica√ß√£o AWS (Ordem de Prioridade):**
   - **Vari√°veis de ambiente** (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`)
   - **Arquivo de credenciais** (`~/.aws/credentials`)
   - **IAM Roles** (detec√ß√£o autom√°tica para EC2/EKS) ‚Üê **Recomendado para produ√ß√£o**

### Script Groovy

Para informa√ß√µes detalhadas sobre o script Groovy, incluindo configura√ß√£o Kubernetes, troubleshooting e par√¢metros espec√≠ficos, consulte o arquivo **[üìñ Documenta√ß√£o Groovy](docs/AWS_LAMBDA_GROOVY_DOCUMENTATION.md)**.

**Uso b√°sico:**
1. **Copiar script:**
   - Use o arquivo `aws-lambda-filter.groovy`
   - Cole no filtro de script do Policy Studio

2. **Configurar credenciais AWS**
3. **Testar com requisi√ß√£o HTTP**

## Estrutura do Projeto

```
aws-lambda-apim-sdk/
‚îú‚îÄ‚îÄ README.md                                # Documenta√ß√£o principal
‚îú‚îÄ‚îÄ docs/                                    # üìö Documenta√ß√£o organizada
‚îÇ   ‚îú‚îÄ‚îÄ üìã INSTALACAO_WINDOWS.md            # Instala√ß√£o Windows
‚îÇ   ‚îú‚îÄ‚îÄ üîß CONFIGURACAO_DINAMICA.md         # Configura√ß√£o din√¢mica
‚îÇ   ‚îú‚îÄ‚îÄ üè∑Ô∏è RELEASE_GUIDE.md                 # Guia de releases
‚îÇ   ‚îú‚îÄ‚îÄ üìä SEMANTIC_VERSIONING.md           # Versionamento sem√¢ntico
‚îÇ   ‚îú‚îÄ‚îÄ üîç ATUALIZACOES_CAMPOS_FILTRO.md   # Hist√≥rico de campos
‚îÇ   ‚îú‚îÄ‚îÄ üîê MELHORIAS_AUTENTICACAO_AWS.md   # Autentica√ß√£o AWS
‚îÇ   ‚îî‚îÄ‚îÄ üìñ AWS_LAMBDA_GROOVY_DOCUMENTATION.md # Documenta√ß√£o Groovy
‚îú‚îÄ‚îÄ build.gradle                             # Configura√ß√£o build + tasks
‚îú‚îÄ‚îÄ aws-lambda-filter.groovy                # Script Groovy
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ linux/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ install-filter.sh               # Instala√ß√£o Linux
‚îÇ   ‚îî‚îÄ‚îÄ windows/
‚îÇ       ‚îú‚îÄ‚îÄ install-filter-windows.ps1      # PowerShell
‚îÇ       ‚îú‚îÄ‚îÄ install-filter-windows.cmd       # CMD
‚îÇ       ‚îú‚îÄ‚îÄ configurar-projeto-windows.ps1  # Configura√ß√£o
‚îÇ       ‚îî‚îÄ‚îÄ test-internationalization.ps1   # Teste
‚îú‚îÄ‚îÄ src/main/                               # C√≥digo fonte
‚îî‚îÄ‚îÄ build/
    ‚îî‚îÄ‚îÄ build/libs/aws-lambda-apim-sdk-1.0.1.jar
```

## Troubleshooting

### Problemas Comuns

1. **Filtro n√£o aparece na paleta:**
   - Verifique se o JAR foi adicionado ao classpath
   - Reinicie o Policy Studio com `-clean`

2. **Erro de credenciais AWS:**
   - Verifique se as credenciais est√£o configuradas
   - Teste com `aws sts get-caller-identity`

3. **Erro de fun√ß√£o n√£o encontrada:**
   - Verifique o nome da fun√ß√£o e a regi√£o
   - Confirme se a fun√ß√£o existe na AWS

### Logs

O filtro gera logs detalhados:
- **Sucesso**: "Success in the AWS Lambda filter"
- **Falha**: "Failed in the AWS Lambda filter"
- **Erro**: "Error in the AWS Lambda Error: ${circuit.exception}"

## Compara√ß√£o das Abordagens

| Aspecto | Filtro Java | Script Groovy |
|---------|-------------|---------------|
| **Interface** | Gr√°fica no Policy Studio | Script de texto |
| **Configura√ß√£o** | Par√¢metros visuais | Vari√°veis no script |
| **Manuten√ß√£o** | Requer rebuild do JAR | Edi√ß√£o direta do script |
| **Performance** | Nativo do gateway | Interpretado |
| **Flexibilidade** | Limitada aos par√¢metros definidos | Totalmente customiz√°vel |
| **Debugging** | Logs estruturados | Logs detalhados |

## Seguran√ßa

- Use IAM Roles quando poss√≠vel
- Rotacione credenciais regularmente
- Use pol√≠ticas IAM com privil√©gios m√≠nimos
- Monitore logs de acesso e execu√ß√£o
- Considere usar AWS Secrets Manager para credenciais sens√≠veis

## Contributing

Please read [Contributing.md](https://github.com/Axway-API-Management-Plus/Common/blob/master/Contributing.md) for details on our code of conduct, and the process for submitting pull requests to us.

## Team

![alt text][Axwaylogo] Axway Team

[Axwaylogo]: https://github.com/Axway-API-Management/Common/blob/master/img/AxwayLogoSmall.png  "Axway logo"

## License
[Apache License 2.0](LICENSE)

## üöÄ **CI/CD Pipeline**

### **GitHub Actions**

O projeto inclui workflows automatizados que usam Docker para build:

#### **CI (Continuous Integration)**
- **Trigger**: Push para `main`, `develop` ou Pull Requests
- **A√ß√µes**:
  - ‚úÖ Login no registry Axway (para imagem base)
  - ‚úÖ Build da imagem Docker de build (com Axway + Gradle)
  - ‚úÖ Build do JAR dentro do container Docker
  - ‚úÖ Upload do JAR como artifact
  - ‚úÖ Testes do JAR

#### **Release**
- **Trigger**: Push de tags (`v*`)
- **A√ß√µes**:
  - ‚úÖ Login no registry Axway
  - ‚úÖ Build da imagem Docker de build
  - ‚úÖ Build do JAR dentro do container
  - ‚úÖ Gera√ß√£o de changelog
  - ‚úÖ Cria√ß√£o de GitHub Release
  - ‚úÖ Upload do JAR para o release
  - ‚úÖ Testes do JAR

### **Fluxo de Build**

```
1. Login no Axway Registry
   ‚Üì
2. Build da imagem Docker (com Axway + Gradle)
   ‚Üì
3. Execu√ß√£o do build do JAR dentro do container
   ‚Üì
4. Gera√ß√£o do JAR final
   ‚Üì
5. Upload para GitHub Release/Artifacts
```

### **Por que usar Docker?**

- **‚úÖ Ambiente Consistente**: Mesmo ambiente Axway sempre
- **‚úÖ Depend√™ncias Garantidas**: Axway + Gradle + Java 11
- **‚úÖ Isolamento**: Build isolado em container
- **‚úÖ Reproduzibilidade**: Mesmo resultado sempre
- **‚úÖ N√£o Publica Imagem**: Apenas usa para build

### **Artefatos Gerados**

#### **JAR Principal**
```
aws-lambda-apim-sdk-1.0.1.jar
‚îú‚îÄ‚îÄ Filtro Java AWS Lambda
‚îú‚îÄ‚îÄ Classes de UI do Policy Studio
‚îú‚îÄ‚îÄ Depend√™ncias AWS SDK
‚îî‚îÄ‚îÄ Configura√ß√µes YAML
```

#### **Localiza√ß√£o**
- **GitHub Releases**: Dispon√≠vel para download
- **GitHub Actions Artifacts**: Durante CI/CD
- **Local**: `build/libs/aws-lambda-apim-sdk-*.jar`

### **Como Usar**

#### **Download do JAR**
1. V√° para **Releases** no GitHub
2. Baixe o JAR da vers√£o desejada
3. Siga o guia de instala√ß√£o

#### **Build Local**
```bash
# Build do JAR (requer Axway local)
./gradlew buildJarLinux

# Ou usando Docker (recomendado)
./scripts/docker/build-with-docker.sh
```

#### **Docker para Desenvolvimento**
```bash
# Build da imagem para desenvolvimento
./scripts/docker/build-image.sh

# Testar
docker run --rm aws-lambda-apim-sdk:latest java -version
```
